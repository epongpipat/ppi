---
title: "Psychophysiological Interaction (PPI)"
author: "Ekarin Eric Pongpipat, M.A."
date: "2019-01-05"
output: 
  html_document:
    highlight: textmate
    theme: lumen
    code_folding: hide
    code_download: true
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: yes
      smooth_scroll: yes
---

## R Libraries
```{r}
packages <- c("ppi", "tidyverse")
xfun::pkg_attach(packages, message = F, install = T)
```

## Data Wrangling
```{r}
# mri parameters
tr <- 3
n_volumes <- 105

psy_events <- readr::read_tsv(url("https://openneuro.org/crn/datasets/ds000171/snapshots/00001/files/sub-control01:func:sub-control01_task-music_run-1_events.tsv")) %>%
  mutate(trial_type = as.factor(trial_type))

psy_contrast_table <- cbind(stimulus_vs_response = c(1, 1, -3, 1)/4,
                                          music_vs_tones = c(1, 1, 0, -2)/3,
                                          positive_music_vs_negative_music = c(-1, 1, 0, 0)/2)

upsample_factor <- 16
hrf <- create_hrf_afni("spmg1", tr, upsample_factor)

phys_left_parietal <- "~/Desktop/sub-control01_task-music_run-1_bold_space-subj_vox-32-24-38.csv"

phys_target_file <- "~/Desktop/sub-control01_task-music_run-1_bold_space-subj_vox-48-24-36.csv"

phys_seed <- read_csv(phys_left_parietal, col_names = "seed")
psy_unlabeled_trial_type <- "response"

phys_target <- read_csv(phys_target_file, col_names = "target")

data_wrangled_left <- data_wrangling(psy_events, psy_unlabeled_trial_type, psy_contrast_table, phys_seed, 2, "spmg1", tr, n_volumes, upsample_factor)

data_wrangled_right <- data_wrangling(psy_events, psy_unlabeled_trial_type, psy_contrast_table, phys_target, 2, "spmg1", tr, n_volumes, upsample_factor)
```

## Analysis

### Seed-to-Seed
```{r}
design_matrix <- array(0, dim = c(105, 7, 2))
design_matrix[,,1] <- as.matrix(data_wrangled_left$design_matrix)
design_matrix[,,2] <- as.matrix(data_wrangled_right$design_matrix)

target_data <- cbind(phys_seed, phys_target)

func_analyze <- function(y, X) {
  data <- merge(y, X)
  colnames(data)[1] <- "target"
  model <- lm(target ~ ., data)
  return(model)
}

model <- apply(design_matrix, 3, function(x) apply(target_data, 2, function(y) func_analyze(y, x)))

# extract estimate for each predictor
tidy_4d <- array(NA, c(2, 2, 8, 4))
residual <- array(NA, c(2, 2, ))
n_seed <- length(model)
idx <- 1
for (i in 1:n_seed) {
  n_target <- length(model[[i]])
  for (j in 1:n_target) {
      tidy_4d[i,j,,] <- broom::tidy(model[[i]][[j]]) %>% select(-term) %>% as.matrix()
      idx <- idx + 1
  }
}

estimates <- tidy_4d[,,,1]
se <- tidy_4d[,,,2]
t_stat <- tidy_4d[,,,3]
p_stat <- tidy_4d[,,,4]



broom::augment(model[[i]][[j]]) %>% select()
```

```{r}

```

### Cor()
```{r}
cor(phys_seed, phys_target)
```
